<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #000; color: white; height: 100vh; overflow: hidden; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex items-center justify-center md:p-6">
    <div class="glass w-full max-w-6xl h-full md:h-[90vh] md:rounded-[2.5rem] flex overflow-hidden border border-white/10 relative">
        
        <div id="sidebar" class="w-full md:w-80 flex flex-col border-r border-white/5">
            <div class="p-6 flex justify-between items-center">
                <h1 class="text-xl font-black italic">Glass</h1>
                <input id="search" placeholder="Phone #" class="bg-white/5 p-2 rounded-lg text-[10px] w-24 outline-none">
                <button onclick="addContact()" class="text-xs font-bold text-blue-400">ADD</button>
            </div>
            <div id="contact-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
        </div>

        <div id="chat-window" class="hidden md:flex flex-1 flex-col bg-white/[0.01]">
            <div class="p-4 border-b border-white/5 flex items-center gap-4">
                <button onclick="goBack()" class="md:hidden">←</button>
                <h2 id="active-name" class="font-bold text-sm">Select Contact</h2>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
            <div class="p-4 flex gap-2">
                <input id="msg-input" placeholder="Message..." class="flex-1 bg-white/5 p-4 rounded-2xl outline-none">
                <button onclick="send()" class="bg-white text-black px-6 rounded-2xl font-bold">➜</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const me = JSON.parse(localStorage.getItem('user'));
        let activeChat = null;

        socket.emit('login', me);

        function addContact() {
            const phone = document.getElementById('search').value;
            socket.emit('request-contact', { targetPhone: phone, fromUser: me.user });
        }

        socket.on('contact-invite', (data) => {
            if(confirm(data.from + " wants to add you. Accept?")) {
                socket.emit('accept-contact', { to: data.from, from: me.user });
            }
        });

        socket.on('load-my-contacts', (contacts) => {
            document.getElementById('contact-list').innerHTML = contacts.map(u => `
                <div onclick='openChat(${JSON.stringify(u)})' class="p-4 bg-white/5 rounded-2xl cursor-pointer">
                    <p class="font-bold text-sm">${u.user}</p>
                </div>
            `).join('');
        });

        function openChat(user) {
            activeChat = user;
            document.getElementById('active-name').innerText = user.user;
            document.getElementById('messages').innerHTML = "";
            socket.emit('load-history', { from: me.user, to: user.user });
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('chat-window').classList.remove('hidden');
                document.getElementById('chat-window').classList.add('flex');
            }
        }

        function goBack() {
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('chat-window').classList.add('hidden');
        }

        function send() {
            const text = document.getElementById('msg-input').value;
            if(text && activeChat) {
                socket.emit('send-private-msg', { to: activeChat.user, from: me.user, text });
                document.getElementById('msg-input').value = "";
            }
        }

        socket.on('chat-history', (history) => {
            history.forEach(m => display(m.sender, m.text));
        });

        socket.on('receive-msg', (data) => {
            if(activeChat && (data.from === activeChat.user || data.from === me.user)) display(data.from, data.text);
        });

        function display(from, text) {
            const isMe = from === me.user;
            const div = document.createElement('div');
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `<div class="p-3 rounded-2xl ${isMe ? 'bg-white text-black' : 'bg-white/10'}">${text}</div>`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 9999;
        }
    </script>
</body>
</html>
