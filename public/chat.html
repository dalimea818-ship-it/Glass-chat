<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-black text-white h-screen flex">

<div class="w-72 glass p-4">
  <h1 class="font-bold mb-4">Contacts</h1>
  <div id="users"></div>
</div>

<div class="flex-1 flex flex-col">
  <div class="p-4 border-b flex justify-between">
    <span id="chatWith">Select a contact</span>
    <button onclick="startCall()" class="border px-4 rounded">Call</button>
  </div>

  <div id="messages" class="flex-1 p-4 overflow-y-auto"></div>

  <div class="p-4 flex gap-2">
    <input id="msg" class="flex-1 bg-gray-800 p-2 rounded">
    <button onclick="sendMsg()" class="bg-white text-black px-4 rounded">Send</button>
  </div>
</div>

<!-- CALL OVERLAY -->
<div id="callUI" class="hidden fixed inset-0 bg-black flex flex-col items-center justify-center">
  <video id="remote" autoplay class="w-full h-full object-cover"></video>
  <video id="local" autoplay muted class="w-40 absolute bottom-4 right-4"></video>

  <div class="absolute bottom-10 flex gap-6">
    <button onclick="toggleMute()">ğŸ¤</button>
    <button onclick="endCall()">âŒ</button>
    <button onclick="toggleCam()">ğŸ“·</button>
  </div>
</div>

<script>
const socket = io();
const me = JSON.parse(localStorage.getItem("user")) || { user: prompt("Username") };
let activeUser = null;
let peer, localStream;

socket.emit("login", me);

socket.on("online-users", users => {
  const u = document.getElementById("users");
  u.innerHTML = "";
  users.filter(x => x !== me.user).forEach(user => {
    const d = document.createElement("div");
    d.textContent = user;
    d.onclick = () => openChat(user);
    u.appendChild(d);
  });
});

function openChat(user) {
  activeUser = user;
  document.getElementById("chatWith").innerText = user;
  socket.emit("join-room", { me: me.user, other: user });
}

function sendMsg() {
  const text = msg.value;
  socket.emit("send-msg", { from: me.user, to: activeUser, text });
  msg.value = "";
}

socket.on("receive-msg", d => {
  const m = document.createElement("div");
  m.textContent = `${d.from}: ${d.text}`;
  messages.appendChild(m);
});

/* ---------- WEBRTC ---------- */

async function startCall() {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  peer = new RTCPeerConnection();

  localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
  local.srcObject = localStream;

  peer.ontrack = e => remote.srcObject = e.streams[0];
  peer.onicecandidate = e => {
    if (e.candidate) socket.emit("ice-candidate", { to: activeUser, candidate: e.candidate });
  };

  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);
  socket.emit("call-user", { to: activeUser, from: me.user, signal: offer });

  callUI.classList.remove("hidden");
}

socket.on("incoming-call", async ({ from, signal }) => {
  activeUser = from;
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  peer = new RTCPeerConnection();

  localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
  local.srcObject = localStream;

  peer.ontrack = e => remote.srcObject = e.streams[0];
  peer.onicecandidate = e => {
    if (e.candidate) socket.emit("ice-candidate", { to: from, candidate: e.candidate });
  };

  await peer.setRemoteDescription(signal);
  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);

  socket.emit("answer-call", { to: from, signal: answer });
  callUI.classList.remove("hidden");
});

socket.on("call-answered", async signal => {
  await peer.setRemoteDescription(signal);
});

socket.on("ice-candidate", c => peer.addIceCandidate(c));

function endCall() {
  peer.close();
  localStream.getTracks().forEach(t => t.stop());
  callUI.classList.add("hidden");
}

function toggleMute() {
  localStream.getAudioTracks()[0].enabled ^= true;
}

function toggleCam() {
  localStream.getVideoTracks()[0].enabled ^= true;
}
</script>

</body>
</html>