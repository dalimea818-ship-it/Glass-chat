<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { background: #000; color: white; height: 100vh; overflow: hidden; }
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); }
    .hidden { display: none !important; }
  </style>
</head>
<body class="flex items-center justify-center p-0 md:p-6">

  <div id="tutorial" class="hidden fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-8 text-center">
    <div>
      <div class="text-6xl mb-4">✨</div>
      <h2 class="text-2xl font-bold mb-2">Welcome to Glass Pro</h2>
      <p class="opacity-60 mb-8 text-sm">To start chatting, search for a friend's phone number. You'll only see people who accept your request.</p>
      <button onclick="closeTutorial()" class="w-full py-4 bg-white text-black rounded-2xl font-bold">START</button>
    </div>
  </div>

  <div class="glass w-full max-w-6xl h-full md:h-[90vh] md:rounded-[2.5rem] flex overflow-hidden border border-white/10">
    
    <div id="sidebar" class="w-full md:w-80 flex flex-col border-r border-white/5">
      <div class="p-6 flex justify-between items-center">
        <h1 class="text-xl font-black italic">Glass</h1>
        <img id="my-pfp" class="w-8 h-8 rounded-full border border-white/20">
      </div>
      
      <div class="px-4 mb-4">
        <div class="bg-white/5 rounded-xl flex items-center px-3 border border-white/10">
          <input id="search-input" placeholder="Enter phone number..." class="w-full p-3 bg-transparent text-xs outline-none">
          <button onclick="addContact()" class="text-blue-400 text-[10px] font-bold">ADD</button>
        </div>
      </div>

      <div id="contact-list" class="flex-1 overflow-y-auto px-2 space-y-1">
        <p class="text-[10px] opacity-30 text-center mt-10 uppercase tracking-widest">No contacts yet</p>
      </div>
    </div>

    <div id="chat-window" class="hidden md:flex flex-1 flex-col bg-white/[0.01]">
      <div class="p-4 border-b border-white/5 flex items-center gap-4">
        <button onclick="goBack()" class="md:hidden text-xl">←</button>
        <img id="active-pfp" class="w-10 h-10 rounded-full hidden">
        <h2 id="active-name" class="font-bold text-sm">Select a contact</h2>
      </div>

      <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

      <div class="p-4 flex gap-2">
        <input id="msg-input" placeholder="Message..." class="flex-1 bg-white/5 p-4 rounded-2xl outline-none border border-white/5">
        <button onclick="send()" class="bg-white text-black px-6 rounded-2xl font-bold">➜</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const me = JSON.parse(localStorage.getItem('user'));
    let activeChat = null;
    let myContacts = [];

    // Login & Tutorial
    if(!me) window.location.href = "/";
    document.getElementById('my-pfp').src = me.pfp;
    socket.emit('login', me);

    if(!localStorage.getItem('setup')) {
      document.getElementById('tutorial').classList.remove('hidden');
    }
    function closeTutorial() {
      document.getElementById('tutorial').classList.add('hidden');
      localStorage.setItem('setup', 'true');
    }

    // Contact Logic
    function addContact() {
      const phone = document.getElementById('search-input').value;
      socket.emit('request-contact', { targetPhone: phone, fromUser: me.user, fromPfp: me.pfp });
      alert("Request Sent!");
    }

    socket.on('contact-invite', (data) => {
      if(confirm(data.from + " wants to add you. Accept?")) {
        socket.emit('accept-contact', { to: data.from, from: me.user });
      }
    });

    socket.on('contact-added', (user) => {
      myContacts.push(user);
      renderContacts();
    });

    function renderContacts() {
      const list = document.getElementById('contact-list');
      list.innerHTML = myContacts.map(u => `
        <div onclick='openChat(${JSON.stringify(u)})' class="p-4 flex items-center gap-4 hover:bg-white/5 rounded-2xl cursor-pointer">
          <img src="${u.pfp}" class="w-12 h-12 rounded-full object-cover">
          <div><p class="font-bold text-sm">${u.user}</p><p class="text-[10px] opacity-40">Online</p></div>
        </div>
      `).join('');
    }

    // Navigation Logic
    function openChat(user) {
      activeChat = user;
      document.getElementById('active-name').innerText = user.user;
      document.getElementById('active-pfp').src = user.pfp;
      document.getElementById('active-pfp').classList.remove('hidden');
      
      if(window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('hidden');
        document.getElementById('chat-window').classList.remove('hidden');
        document.getElementById('chat-window').classList.add('flex');
      }
    }

    function goBack() {
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('chat-window').classList.add('hidden');
      document.getElementById('chat-window').classList.remove('flex');
    }

    function send() {
      const text = document.getElementById('msg-input').value;
      if(text && activeChat) {
        socket.emit('send-private-msg', { to: activeChat.user, from: me.user, text, pfp: me.pfp });
        document.getElementById('msg-input').value = "";
      }
    }

    socket.on('receive-msg', (data) => {
      const isMe = data.from === me.user;
      const div = document.createElement('div');
      div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
      div.innerHTML = `<div class="p-3 rounded-2xl max-w-[70%] ${isMe ? 'bg-white text-black' : 'bg-white/10 text-white'}">${data.text}</div>`;
      document.getElementById('messages').appendChild(div);
      document.getElementById('messages').scrollTop = 9999;
    });
  </script>
</body>
</html>
