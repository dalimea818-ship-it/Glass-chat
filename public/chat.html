<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>

<style>
.glass{background:rgba(255,255,255,.08);backdrop-filter:blur(20px)}
.call-btn{width:52px;height:52px;border-radius:999px;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center}
.call-btn svg{stroke:white}
</style>
</head>

<body class="bg-black text-white h-screen flex">

<!-- CONTACT LIST -->
<div class="w-72 glass p-4">
  <h1 class="font-bold mb-4">Contacts</h1>
  <div id="users"></div>
</div>

<!-- CHAT -->
<div class="flex-1 flex flex-col">
  <div class="p-4 border-b flex justify-between">
    <span id="chatWith">Select contact</span>
    <div class="flex gap-2">
      <button onclick="startCall()" class="border px-4 rounded">Call</button>
      <button onclick="openSettings()" class="border px-4 rounded">âš™</button>
    </div>
  </div>

  <div id="messages" class="flex-1 p-4 overflow-y-auto"></div>

  <div class="p-4 flex gap-2">
    <input id="msg" class="flex-1 bg-gray-800 p-2 rounded">
    <button onclick="sendMsg()" class="bg-white text-black px-4 rounded">Send</button>
  </div>
</div>

<!-- CALL UI -->
<div id="callUI" class="hidden fixed inset-0 bg-black z-50">
  <video id="remote" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
  <video id="local" autoplay muted playsinline class="absolute bottom-28 right-6 w-32 h-48 rounded-xl"></video>

  <div class="absolute top-6 w-full text-center text-lg" id="callWith"></div>

  <div class="absolute bottom-6 w-full flex justify-center">
    <div class="glass flex gap-6 px-8 py-4 rounded-full">
      <button onclick="toggleMute()" class="call-btn" id="micBtn"><i data-feather="mic"></i></button>
      <button onclick="toggleCam()" class="call-btn" id="camBtn"><i data-feather="video"></i></button>
      <button onclick="flipCamera()" class="call-btn"><i data-feather="refresh-ccw"></i></button>
      <button onclick="cycleFilter()" class="call-btn"><i data-feather="aperture"></i></button>
      <button onclick="endCall()" class="call-btn bg-red-600"><i data-feather="phone-off"></i></button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsPanel" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
  <div class="glass p-6 rounded-3xl w-80">
    <h2 class="text-xl mb-4">Settings</h2>
    <input type="file" accept="image/*,video/mp4" onchange="setWallpaper(event)">
    <label class="flex gap-2 mt-4">
      <input type="checkbox" id="autoCam"> Auto camera on call
    </label>
    <button onclick="closeSettings()" class="mt-6 border px-4 py-2 rounded">Close</button>
  </div>
</div>

<!-- TUTORIAL -->
<div id="tutorial" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
  <div class="glass p-6 rounded-xl text-center">
    <h2 id="tTitle"></h2>
    <p id="tText" class="opacity-70 my-4"></p>
    <button onclick="nextStep()" class="bg-white text-black px-4 py-2 rounded">Next</button>
  </div>
</div>

<script>
const socket=io();
const me={user:localStorage.user||prompt("Username")};
localStorage.user=me.user;

let activeUser,peer,localStream;
let muted=false,camOff=false,facing="user",filter=0;

socket.emit("login",me);

socket.on("online-users",users=>{
  usersDiv.innerHTML="";
  users.filter(u=>u!==me.user).forEach(u=>{
    let d=document.createElement("div");
    d.textContent=u;
    d.onclick=()=>openChat(u);
    usersDiv.appendChild(d);
  });
});

function openChat(u){
  activeUser=u;
  chatWith.innerText=u;
  socket.emit("join-room",{me:me.user,other:u});
}

function sendMsg(){
  socket.emit("send-msg",{from:me.user,to:activeUser,text:msg.value});
  msg.value="";
}

socket.on("receive-msg",d=>{
  let m=document.createElement("div");
  m.textContent=d.from+": "+d.text;
  messages.appendChild(m);
});

async function startCall(){
  callUI.classList.remove("hidden");
  callWith.innerText=activeUser;
  feather.replace();

  localStream=await navigator.mediaDevices.getUserMedia({video:autoCam.checked,audio:true});
  peer=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

  localStream.getTracks().forEach(t=>peer.addTrack(t,localStream));
  local.srcObject=localStream;

  peer.ontrack=e=>remote.srcObject=e.streams[0];
  peer.onicecandidate=e=>e.candidate&&socket.emit("ice-candidate",{to:activeUser,candidate:e.candidate});

  let offer=await peer.createOffer();
  await peer.setLocalDescription(offer);
  socket.emit("call-user",{to:activeUser,from:me.user,signal:offer});
}

socket.on("incoming-call",async d=>{
  activeUser=d.from;
  callUI.classList.remove("hidden");
  feather.replace();

  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  peer=new RTCPeerConnection();

  localStream.getTracks().forEach(t=>peer.addTrack(t,localStream));
  local.srcObject=localStream;

  peer.ontrack=e=>remote.srcObject=e.streams[0];
  peer.onicecandidate=e=>e.candidate&&socket.emit("ice-candidate",{to:activeUser,candidate:e.candidate});

  await peer.setRemoteDescription(d.signal);
  let ans=await peer.createAnswer();
  await peer.setLocalDescription(ans);
  socket.emit("answer-call",{to:activeUser,signal:ans});
});

socket.on("call-answered",s=>peer.setRemoteDescription(s));
socket.on("ice-candidate",c=>peer.addIceCandidate(c));

function endCall(){
  peer.close();
  localStream.getTracks().forEach(t=>t.stop());
  callUI.classList.add("hidden");
}

function toggleMute(){muted=!muted;localStream.getAudioTracks()[0].enabled=!muted;}
function toggleCam(){camOff=!camOff;localStream.getVideoTracks()[0].enabled=!camOff;}

async function flipCamera(){
  facing=facing==="user"?"environment":"user";
  let s=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing},audio:true});
  let t=s.getVideoTracks()[0];
  peer.getSenders().find(x=>x.track.kind==="video").replaceTrack(t);
  local.srcObject=s;
  localStream=s;
}

const filters=["none","grayscale(1)","sepia(1)","contrast(1.4)","blur(2px)"];
function cycleFilter(){filter=(filter+1)%filters.length;remote.style.filter=local.style.filter=filters[filter];}

function openSettings(){settingsPanel.classList.remove("hidden")}
function closeSettings(){settingsPanel.classList.add("hidden")}
function setWallpaper(e){document.body.style.background=`url(${URL.createObjectURL(e.target.files[0])}) center/cover fixed`}

const steps=[
{t:"Welcome","d":"Private secure messenger"},
{t:"Contacts","d":"Chat with added contacts"},
{t:"Calls","d":"HD video & voice calls"},
{t:"Settings","d":"Customize your experience"}
];
let step=0;
function nextStep(){
  if(step>=steps.length){tutorial.classList.add("hidden");localStorage.tutorial=1;return}
  tTitle.innerText=steps[step].t;
  tText.innerText=steps[step++].d;
}
if(!localStorage.tutorial){tutorial.classList.remove("hidden");nextStep()}
</script>

</body>
</html>